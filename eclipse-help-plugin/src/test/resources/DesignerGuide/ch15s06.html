<html><head><META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Persistence API</title><link href="css/book.css" type="text/css" rel="stylesheet"><meta content="DocBook XSL Stylesheets V1.78.0" name="generator"><link rel="home" href="index.html" title="Xpert.ivy 5.1"><link rel="up" href="ch15.html" title="Chapter&nbsp;15.&nbsp;Persistence"><link rel="prev" href="ch15s05.html" title="Generate database schema from persistence unit"><link rel="next" href="ch16.html" title="Chapter&nbsp;16.&nbsp;Overrides"><script src="PLUGINS_ROOT/org.eclipse.help/livehelp.js" language="JavaScript"></script></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table summary="Navigation header" width="100%"><tr><th align="center" colspan="3">Persistence API</th></tr><tr><td align="left" width="20%"><a accesskey="p" href="ch15s05.html">Prev</a>&nbsp;</td><th align="center" width="60%">Chapter&nbsp;15.&nbsp;Persistence</th><td align="right" width="20%">&nbsp;<a accesskey="n" href="ch16.html">Next</a></td></tr></table><hr></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ivy.persistence.api"></a>Persistence API</h2></div></div></div>
    
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="ivy.persistence.api.overview"></a>Overview</h3></div></div></div>
        
        <p>The Xpert.ivy Persistence API is used to load entity objects directly from the
            database or save/update them on the database. The Persistence API can be accessed by
            IvyScript anywhere scripting is supported. The Persistence API can only deal with entity
            objects, means objects of type <a class="link" href="ch15.html#ivy.persistence.entityclasses" title="Entity Classes">Entity Classes</a>.
            The Persistence API can be found under <code class="code">ivy.persistence.</code>
                    <span class="italic">&lt;persistence unit&gt;</span>. Here you find all the methods for
            finding, persisting, updating and querying entity objects. See <code class="code">
                        <a class="ulink" href="../PublicAPI/ch/ivyteam/ivy/process/data/persistence/IIvyEntityManager.html">IIvyEntityManager</a>
                    </code> fore more information. Replace <span class="italic">&lt;persistence unit&gt;</span> with the name of a persistence unit.
            The persistence units can be configured with the <a class="link" href="ch15s04.html" title="Persistence Configuration Editor">Persistence Configuration
            Editor</a>.</p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="ivy.persistence.api.persist"></a>Persist an entity object</h3></div></div></div>
        
        <p>To persist (save/create object on the database) you can use the <code class="code">persist()</code>
            method of the Persistence API.</p>
        <div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3>
            <p>This method only works properly if the entity object and all the associated
                objects are not jet persistent. Otherwise you have to use the merge method.</p>
        </div>
        <p>Example (Product is an Entity
            Class):</p><pre class="screen">// persist new created product
Product product;
product.name = "Product name";
product.nr = 12;
ivy.persistence.<span class="italic">&lt;persistence unit&gt;</span>.persist(product);

// get id of new created product
Number newProductId = product.id;</pre><p>
                </p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="ivy.persistence.api.merge"></a>Find an entity object by id</h3></div></div></div>
        
        <p>To find an entity object by id (select object on the database) you can use the
                <code class="code">find()</code> method of the Persistence API.</p>
        <p>Example (Product is an Entity
            Class):</p><pre class="screen">// load product with id 1 from the database
Product product = ivy.persistence.<span class="italic">&lt;persistence unit&gt;</span>
.find(Product.class, 1) as Product;</pre><p>
                </p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="ivy.persistence.api.find"></a>Merge an entity object</h3></div></div></div>
        
        <p>To merge (update or save/create object on the database) you can use the
            <code class="code">merge()</code> method of the Persistence API.</p>
        <div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3>
            <p>Only the returned entity object of this method is the really updated or
                saved/created object. The object given to this method is not changed.</p>
        </div>
        <p>Example update (Product is an Entity
            Class):</p><pre class="screen">...
// change before loaded product
product.name = "New product name"
Product updatedProduct = ivy.persistence.<span class="italic">&lt;persistence unit&gt;</span>
.merge(product) as Product;</pre><p>

                </p>
        <p>Example save/create (Product is an Entity
            Class):</p><pre class="screen">// save new created product
Product product;
product.name = "Product name";
product.nr = 12;
Product savedProduct = ivy.persistence.<span class="italic">&lt;persistence unit&gt;</span>
.merge(product) as Product;

// get id of new created product
Number newProductId = savedProduct.id;</pre><p>
                </p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="ivy.persistence.api.remove"></a>Remove an entity object</h3></div></div></div>
        
        <p>To remove (delete object on the database) you can use the <code class="code">remove()</code> method
            of the Persistence API.</p>
        <p>Example (Product is an Entity
            Class):</p><pre class="screen">...
// delete the product from the database
ivy.persistence.<span class="italic">&lt;persistence unit&gt;</span>.remove(product);</pre><p>
                </p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="ivy.persistence.api.refresh"></a>Refresh an entity object</h3></div></div></div>
        
        <p>To refresh (reload object from the database) you can use the <code class="code">refresh()</code>
            method of the Persistence API.</p>
        <p>Example (Product is an Entity
            Class):</p><pre class="screen">...
// change before loaded product
product.name = "New product name"
// reload object from the database and revert local changes
ivy.persistence.<span class="italic">&lt;persistence unit&gt;</span>.refresh(product);</pre><p>
                </p>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="ivy.persistence.api.query"></a>Persistence Queries (JPA QL)</h3></div></div></div>
        
        <p>With the Persistence API it is possible to execute Java Persistence API Query Language
            (JPA QL) statements. See <code class="code">
                        <a class="ulink" href="../PublicAPI/ch/ivyteam/ivy/process/data/persistence/IIvyQuery.html">IIvyQuery</a>

                    </code> for more information about the Query API. The query
            language based around the objects that are persisted but with syntax very similar to
            SQL. You have always to use the names of the Entity Class and the attributes and not the
            names from the database. </p>
        <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="ivy.persistence.api.query.single.case-sensitivity"></a>Case Sensitivity</h4></div></div></div>
            
            <p>Queries are case-insensitive, except for names of Java classes and properties. So
                    <code class="code">SeLeCT</code> is the same as <code class="code">sELEct</code> is the same as
                    <code class="code">select</code> but <code class="code">PRODUCT</code> is not <code class="code">product</code> and
                    <code class="code">foo.barSet</code> is not <code class="code">foo.BARSET</code>. This manual uses
                lowercase JPA QL keywords.</p>
        </div>
        <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="ivy.persistence.api.query.single.result"></a>Single Result</h4></div></div></div>
            
            <p>To execute a JPA query where you are expecting a single value to be returned you
                would call <code class="code">getSingleResult()</code>. This will return the single Object. If
                the query returns more than one result then you will get an Exception. This should
                not be called with "UPDATE"/"DELETE" queries. </p>
            <p>Example (Product is an Entity
                Class):</p><pre class="screen">Product product = ivy.persistence.<span class="italic">&lt;persistence unit&gt;</span>
.createQuery("select p from Product p where p.id = :id")
.setParameter("id", 1)
.getSingleResult() as Product;</pre><p>

                    </p>
            <div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3>
                <p>Calling this method in automatic transaction mode (by default) will close the
                    recordset automatically. Consequently you can not invoke this method multiple
                    times or in combination with <code class="code">getResultList()</code> on the same query.
                </p>
            </div>
        </div>
        <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="ivy.persistence.api.query.result.list"></a>Result List</h4></div></div></div>
            
            <p>To execute a JPA query you would typically call <code class="code">getResultList()</code>. This
                will return a List of results. This should not be called with "UPDATE"/"DELETE"
                queries. </p>
            <p>Example (Product is an Entity
                Class):</p><pre class="screen">List&lt;Product&gt; products = ivy.persistence.<span class="italic">&lt;persistence unit&gt;</span>
.createQuery("select p from Product p where p.price &gt; :price")
.setParameter("price", 10)
.getResultList();</pre><p>

                    </p>
            <div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3>
                <p>Calling this method in automatic transaction mode (by default) will close the
                    recordset automatically. Consequently you can not invoke this method multiple
                    times or in combination with <code class="code">getSingleResult()</code> on the same query.
                </p>
            </div>
        </div>
        <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="ivy.persistence.api.query.update"></a>Execute Update</h4></div></div></div>
            
            <p>To execute a JPA UPDATE/DELETE query you would call <code class="code">executeUpdate()</code>.
                This will return the number of objects changed by the call. This should not be
                called with "select" queries. </p>
            <p>Example delete (Product is an Entity
                Class):</p><pre class="screen">// delete all products
Number deletedRows = ivy.persistence.<span class="italic">&lt;persistence unit&gt;</span>
.createQuery("delete from Product p")
.executeUpdate()</pre><p>

                    </p>
            <p>Example update (Product is an Entity
                Class):</p><pre class="screen">// update product name
Number updatedRows = ivy.persistence.<span class="italic">&lt;persistence unit&gt;</span>
.createQuery("update Product set name = :newName where name = :oldName")
.setParameter( "newName", "New Product Name" )
.setParameter( "oldName", "Old Product Name" )
.executeUpdate();</pre><p>
                    </p>
        </div>
        <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="ivy.persistence.api.query.parameters"></a>Parameter binding</h4></div></div></div>
            
            <p>The JPA Queries supports named and numbered parameters and provides methods for
                setting the value of a particular parameter.</p>
            <div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3>
                <p>You should always use parameter binding and do not build the query with string
                    concatenation, because of performance reasons.</p>
            </div>
            <p>Example with named
                parameter:</p><pre class="screen">ivy.persistence.<span class="italic">&lt;persistence unit&gt;</span>
.createQuery("select p from Product p where p.price &gt; :price")
.setParameter("price", 10)</pre><p>

                    </p>
            <p>Example with positional
                parameter:</p><pre class="screen">ivy.persistence.<span class="italic">&lt;persistence unit&gt;</span>
.createQuery("select p from Product p where p.price &gt; ?1 and p.amount &lt;= ?2")
.setParameter(1, 10).setParameter(2, 80)</pre><p>
                    </p>
        </div>
        <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="ivy.persistence.api.query.paging"></a>Paging the result</h4></div></div></div>
            
            <p>To specify the range of a query you have the two methods
                <code class="code">setFirstResult()</code> and <code class="code">setMaxResults()</code> available. The start
                position of the first result, numbered from 0.</p>
            <p>Example (Product is an Entity
                Class):</p><pre class="screen">List&lt;Product&gt; products = ivy.persistence.<span class="italic">&lt;persistence unit&gt;</span>
.createQuery("select p from Product p where p.price &gt; :price")
.setParameter("price", 10)
.setFirstResult(40)
.setMaxResults(20).getResultList();</pre><p>

                    </p>
            <p>The call to <code class="code">setFirstResult(40)</code> means starting from the fortieth
                object. The call to <code class="code">setMaxResults(20)</code> limits the query result set to 20
                objects (rows) returned by the database.</p>
        </div>
        <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="ivy.persistence.api.query.ordering"></a>Ordering</h4></div></div></div>
            
            <p>JPA QL provide an ORDER BY clause for ordering query results, similar to SQL. </p>
            <p>Returns all Products ordered by
                name:</p><pre class="screen">from Product p order by p.name</pre><p>
                    </p>
            <p>You specify ascending and descending order using asc or desc:
                </p><pre class="screen">from Product p order by p.name desc</pre><p>
                    </p>
            <p>You may order by multiple properties:
                </p><pre class="screen">from Product p order by p.name asc, p.description desc</pre><p>
                    </p>
        </div>
        <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="ivy.persistence.api.query.distinct"></a>Distinct results</h4></div></div></div>
            
            <p>When you use a select clause, the elements of the result are no longer guaranteed
                to be unique.</p>
            <p>DISTINCT eliminates duplicates from the returned list of product descriptions.
                </p><pre class="screen">select distinct p.description from Product p</pre><p>
                    </p>
        </div>
        <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="ivy.persistence.api.query.comparison"></a>Comparison expressions</h4></div></div></div>
            
            <p>JPA QL support the same basic comparison operators as SQL. Here are a few examples
                that should look familiar if you know SQL: </p>
            <p>Binary comparison (=, &lt;&gt;, &lt;, &gt;, &gt;=, &lt;=, [NOT] BETWEEN, [NOT]
                IN):</p><pre class="screen">from Product p where p.amount = 100
from Product p where p.amount &lt;&gt; 100
from Product p where p.amount &gt; 100
from Product p where p.amount &lt;= 100
from Product p where p.amount between 1 and 10
from Product p where p.name in ('Product A', 'Product B')            </pre><p>
                    </p>
            <p>Null check (IS [NOT]
                NULL):</p><pre class="screen">from Product p where p.name is null
from Product p where p.name is not null          </pre><p>
                    </p>
            <p>Arithmetic expressions (+, -, *, /):
                </p><pre class="screen">from Product p where ( p.amount / 0.71 ) - 100.0 &gt; 0.0</pre><p>
                    </p>
            <p>The LIKE operator accepts a string value as input parameter in which an underscore
                (_) stands for any single character, a percent (%) character stands for any sequence
                of characters (including the empty sequence), and all other characters stand for
                themselves:
                </p><pre class="screen">from Product p where p.name like 'A%'
from Product p where p.name not like '_a_'</pre><p>
                    </p>
            <p>Logical operators (NOT, AND,
                OR):</p><pre class="screen">from Product p
    where p.name like 'A%' and p.price &gt; 10</pre><p>
                    </p>
            <p>Expressions with collections (IS [NOT] EMPTY, [NOT] MEMBER
                [OF]):</p><pre class="screen">from Product p where p.customers is not empty
from Product p, Category c where p member of c.products</pre><p>
                    </p>
            <p>
                </p><div class="table"><a name="N2CD74"></a><p class="title"><b>Table&nbsp;15.1.&nbsp;JPA QL operator precedence</b></p><div class="table-contents">
                    
                    <table summary="JPA QL operator precedence" border="0"><colgroup><col class="c1"><col class="c2"></colgroup><thead><tr><th>Operators</th><th>Description</th></tr></thead><tbody><tr><td>. </td><td>Navigation path expression operator </td></tr><tr><td>+, - </td><td>Unary positive or negative signing (all unsigned numeric
                                    values are considered positive) </td></tr><tr><td>*, / </td><td>Regular multiplication and division of numeric values
                                </td></tr><tr><td>+, - </td><td>Regular addition and subtraction of numeric values </td></tr><tr><td>=, &lt;&gt;, &lt;, &gt;, &gt;=, &lt;=, [NOT] BETWEEN, [NOT] IN, IS
                                    [NOT] NULL, [NOT] LIKE</td><td>Binary comparison operators with SQL semantics </td></tr><tr><td>IS [NOT] EMPTY, [NOT] MEMBER [OF] </td><td>Binary operators for collections in JPA QL </td></tr><tr><td>NOT, AND, OR </td><td>Logical operators for ordering of expression evaluation
                                </td></tr></tbody></table>
                </div></div><p><br class="table-break">
            </p>
        </div>
        <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="ivy.persistence.api.query.functions"></a>Calling functions</h4></div></div></div>
            
            <p>An extremely powerful feature of JPA QL is the ability to call SQL functions in
                the where and HAVING clauses of a query.</p>
            <p>Lower cases or upper cases a string (LOWER(string),
                UPPER(string)):</p><pre class="screen">from Product p where lower(p.name) = 'product name'
from Product p where upper(p.name) = 'PRODUCT NAME'</pre><p>
                    </p>
            <p>Another common expression is concatenation, although SQL dialects are different
                here, JPA QL support a portable concat(string1, string2) function:
                </p><pre class="screen">from Product p where concat(p.name, p.description) like 'A% B%'</pre><p>
                    </p>
            <p>Size of a collection
                (SIZE(collection)):</p><pre class="screen">from Product p where size(p.customers) &gt; 10</pre><p>
                    </p>
            <p>
                </p><div class="table"><a name="N2CDF7"></a><p class="title"><b>Table&nbsp;15.2.&nbsp;JPA QL functions</b></p><div class="table-contents">
                    
                    <table summary="JPA QL functions" border="0"><colgroup><col class="c1"><col class="newCol2"><col class="c2"></colgroup><thead><tr><th>Function</th><th>Return</th><th>Description</th></tr></thead><tbody><tr><td>UPPER(string), LOWER(string) </td><td>string</td><td>Lower cases or upper cases a <span class="italic">string</span> value </td></tr><tr><td>CONCAT(string1, string2) </td><td>string</td><td>Concatenates <span class="italic">string</span> values
                                    to one string</td></tr><tr><td>SUBSTRING(string, offset, length) </td><td>string</td><td>Substring string values (<span class="italic">offset</span> starts at 1)</td></tr><tr><td>TRIM( [[BOTH|LEADING|TRAILING] char [from]] string) </td><td>string</td><td>Trims spaces on BOTH sides of <span class="italic">string</span> if no <span class="italic">char</span>
                                    or other specification is given</td></tr><tr><td>LENGTH(string) </td><td>number</td><td>Gets the length of a <span class="italic">string</span> value</td></tr><tr><td>LOCATE(search, string, offset) </td><td>number</td><td>Searches for position of <span class="italic">search</span> in <span class="italic">string</span>
                                    starting at <span class="italic">offset</span>

                                    </td></tr><tr><td>ABS(number), SQRT(number), MOD(dividend, divisor) </td><td>number</td><td>Returns an absolute of same type as input, square root as
                                    double, and the remainder of a division as an integer </td></tr><tr><td>SIZE(collection) </td><td>integer</td><td>Size of a <span class="italic">collection</span>;
                                    returns an integer, or 0 if empty </td></tr></tbody></table>
                </div></div><p><br class="table-break">
            </p>
        </div>
        <div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="ivy.persistence.api.query.aggregate.functions"></a>Aggregate functions</h4></div></div></div>
            
            <p>The aggregate functions that are recognized in JPA QL are <code class="code">count()</code>,
                    <code class="code">min()</code>, <code class="code">max()</code>, <code class="code">sum()</code> and
                <code class="code">avg()</code>.</p>
            <p>This query counts all the Products:
                </p><pre class="screen">Number productCount = ivy.persistence.<span class="italic">&lt;persistence unit&gt;</span>
.createQuery("select count(p) from Product p").getSingleResult() as Number;                </pre><p>
                    </p>
            <p>This query calculates the average the sum, the maximum and the minimum from the
                amount of all products:
                </p><pre class="screen">select avg(p.amount), sum(p.amount), max(p.amount) min(p.amount) from Product p</pre><p>
                    </p>
        </div>
    </div>
    <div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="ivy.persistence.api.accessibility"></a>Accessibility</h3></div></div></div>
        
        <p>You can use the Persistence API everywhere you have the ivy variable in the IvyScript.
            Use <code class="code">ivy.persistence.</code>
                    <span class="italic">&lt;persistence
            unit&gt;</span>. Here you find all the methods for finding, persisting, updating and
            querying entity objects. Replace <span class="italic">&lt;persistence
            unit&gt;</span> with the name of a persistence unit.</p>
    </div>
</div><div class="navfooter"><hr><table summary="Navigation footer" width="100%"><tr><td align="left" width="40%"><a accesskey="p" href="ch15s05.html">Prev</a>&nbsp;</td><td align="center" width="20%"><a accesskey="u" href="ch15.html">Up</a></td><td align="right" width="40%">&nbsp;<a accesskey="n" href="ch16.html">Next</a></td></tr><tr><td valign="top" align="left" width="40%">Generate database schema from persistence unit&nbsp;</td><td align="center" width="20%"><a accesskey="h" href="index.html">Home</a></td><td valign="top" align="right" width="40%">&nbsp;Chapter&nbsp;16.&nbsp;Overrides</td></tr></table></div></body></html>