<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Overview</title>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/imagediff@1.0.8/imagediff.min.js"></script>

  <style>
    td {text-align:center;}
    .textbox {width:50%;}
  </style>

  <form action="javascript:insertRefImages()">
    <input id="refImgUrl" class="textbox" type="text">
    <input type="submit" value="Load">
  </form>

  <form action="javascript:removeIdentical()">
    Tolerance in pixels
    <input id="toleranceInput" type="text" value="0">
    <input type="submit" value="Remove similar images">
  </form>

  <form action="javascript:toggleRefImages()">
    <input type="submit" value="Toggle references">
  </form>

  {generated.img.tag.location}

  <script>
    var refImgUrl = document.getElementById("refImgUrl");
    var toleranceInput = document.getElementById("toleranceInput");
    var imageWidth = '100%';

    function insertRefImages()
    {
      removeElementsWithClass("refImg");
      removeElementsWithClass("diffImg");

      var imgsLive = document.body.getElementsByTagName("img");
      var imgs = [...imgsLive];

      for (let img of imgs)
      {
        var refImg = document.createElement('img');
        refImg.src = refImgUrl.value + "{artifact.target.path}" + img.getAttribute('src');
        refImg.className = "refImg";

        var table = img.parentNode.parentNode;
        table.getElementsByClassName("referenceCol")[0].appendChild(refImg);

        refImg.onload = (function(im, refIm)
        {
          return function()
        {
          addDiffImg(im, refIm);
        };})(img, refImg);
      }
    }

    function removeElementsWithClass(className)
    {
      var elementsLive = document.body.getElementsByClassName(className);
      var elements = [...elementsLive];
    
      for (let element of elements)
      {
        element.parentNode.removeChild(element);
      }
    }

    function createTitles()
    {
      var titleRow = document.createElement("tr");
      titleRow.appendChild(createTitle("Screenshot"));
      titleRow.appendChild(createTitle("Reference"));
      titleRow.appendChild(createTitle("Diff"));
      return titleRow;
    }

    function createTitle(text)
    {
      var titleCol = document.createElement("td");
      titleCol.className = text.toLowerCase() + "Col";
      var title = document.createElement('a');
      title.text = text;
      titleCol.appendChild(title);
      return titleCol;
    }

    function addDiffImg(img, refImg)
    {
      if (img.width == 0 || refImg.width == 0)
      {
        return;
      }
      img.style.width = 'auto';
      refImg.style.width = 'auto';

      var diff = imagediff.diff(img, refImg); 
      var canvas = imagediff.createCanvas(diff.width, diff.height);
      var context = canvas.getContext('2d');
      context.putImageData(diff, 0, 0);

      var table = img.parentNode.parentNode;
      table.getElementsByClassName("diffCol")[0].appendChild(context.canvas);

      img.style.width = imageWidth;
      refImg.style.width = imageWidth;
      canvas.style.width = imageWidth;
      canvas.className = "diffImg";
    }

    function wrapImgsInTables()
    {
      var imgsLive = document.body.getElementsByTagName("img");
      var imgs = [...imgsLive];

      for (let img of imgs)
      {
        img.className = "screenshotImg";
        var table = document.createElement('table');
        table.className = "imageTable";
        document.body.replaceChild(table, img);
        table.appendChild(createTitles());

        var row = document.createElement("tr");

        var screenshotCol = document.createElement("td");
        screenshotCol.className = "screenshotCol";

        var referenceCol = document.createElement("td");
        referenceCol.className = "referenceCol";

        var diffCol = document.createElement("td");
        diffCol.className = "diffCol";

        screenshotCol.appendChild(img);
        row.appendChild(screenshotCol);
        row.appendChild(referenceCol);
        row.appendChild(diffCol);
        table.appendChild(row);
      }
    }

    function fillMasterUrl()
    {
      var currentUrl = window.location.href;
      var index = currentUrl.indexOf("job", currentUrl.indexOf("job") + 1);
      var buildUrl = currentUrl.substring(0, index);
      var masterUrl = buildUrl + "job/master/lastSuccessfulBuild";
      refImgUrl.value = masterUrl;
    }

    function removeIdentical()
    {
      var tablesLive = document.getElementsByClassName("imageTable");
      var tables = [...tablesLive];

      for (let table of tables)
      {
        var screenshot = table.getElementsByClassName("screenshotImg")[0];
        var reference = table.getElementsByClassName("refImg")[0];

        screenshot.style.width = 'auto';
        reference.style.width = 'auto';

        var identical = false;
        if (screenshot.width == reference.width)
        {
          identical = imagediff.equal(screenshot, reference , toleranceInput.value);
        }

        screenshot.style.width = imageWidth;
        reference.style.width = imageWidth;

        if (identical)
        {
          table.parentNode.removeChild(table);
        }
      }
    }

    function toggleRefImages()
    {
      var liveElements = document.querySelectorAll('.refImg, .referenceCol');
      var elements = [...liveElements];

      for (let element of elements)
      {
        element.style.display = element.style.display === 'none' ? '' : 'none';
      }
    }

    wrapImgsInTables();
    fillMasterUrl();

    window.onload = insertRefImages;
  </script>
</body>
</html>