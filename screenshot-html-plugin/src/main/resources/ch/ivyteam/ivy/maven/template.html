<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Overview</title>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/imagediff@1.0.8/imagediff.min.js"></script>

  <style>
    span {
      display:inline-block;
      width:33%;
      text-align:center;
    }
    .textbox {width:50%;}
  </style>

  <form action="javascript:insertRefImages()">
    <input id="refImgUrl" class="textbox" type="text">
    <input type="submit" value="Load">
  </form>

  <form action="javascript:removeIdentical()">
    Tolerance in pixels
    <input id="toleranceInput" type="text" value="0">
    <input type="submit" value="Remove similar images">
  </form>

  <form action="javascript:hideRefImages()">
    <input type="submit" value="Toggle references">
  </form>

  {generated.img.tag.location}

  <script>
    var refImgUrl = document.getElementById("refImgUrl");
    var toleranceInput = document.getElementById("toleranceInput");
    var imageWidth = '33%';

    function insertRefImages()
    {
      removeElementsWithClass("refImg");
      removeElementsWithClass("diffImg");

      var imgsLive = document.body.getElementsByTagName("img");
      var imgs = [...imgsLive];

      for (let img of imgs)
      {
        var refImg = document.createElement('img');
        refImg.src = refImgUrl.value + "{artifact.target.path}" + img.getAttribute('src');
        refImg.className = "refImg";

        img.after(refImg);

        refImg.onload = (function(im, refIm)
        {
          return function()
        {
          addDiffImg(im, refIm);
        };})(img, refImg);
      }
    }

    function removeElementsWithClass(className)
    {
      var elementsLive = document.body.getElementsByClassName(className);
      var elements = [...elementsLive];
    
      for (let element of elements)
      {
        element.parentNode.removeChild(element);
      }
    }

    function addTitle(text, clazz)
    {
      var span = document.createElement('span');
      span.classList.add(clazz)
      var node = document.createElement('a');
      node.text = text;
      span.appendChild(node);
      return span;
    }

    function addDiffImg(img, refImg)
    {
      if (img.width == 0 || refImg.width == 0)
      {
        return;
      }
      img.style.width = 'auto';
      refImg.style.width = 'auto';

      var diff = imagediff.diff(img, refImg); 
      var canvas = imagediff.createCanvas(diff.width, diff.height);
      var context = canvas.getContext('2d');
      context.putImageData(diff, 0, 0);

      refImg.after(context.canvas);

      img.style.width = imageWidth;
      refImg.style.width = imageWidth;
      canvas.style.width = imageWidth;
      canvas.className = "diffImg";
    }

    function wrapImgTagInDiv()
    {
      var imgsLive = document.body.getElementsByTagName("img");
      var imgs = [...imgsLive];

      for (let img of imgs)
      {
        img.className = "screenshotImg";
        var divTag = document.createElement('div');
        divTag.className = "imageDiv";
        document.body.replaceChild(divTag, img);
        divTag.appendChild(addTitle("Screenshot", "screenshotTitle"));
        divTag.appendChild(addTitle("Reference", "refTitle"));
        divTag.appendChild(addTitle("Diff", "diffTitle"));
        divTag.appendChild(img);
      }
    }

    function fillMasterUrl()
    {
      var currentUrl = window.location.href;
      var index = currentUrl.indexOf("job", currentUrl.indexOf("job") + 1);
      var buildUrl = currentUrl.substring(0, index);
      var masterUrl = buildUrl + "job/master/lastSuccessfulBuild";
      refImgUrl.value = masterUrl;
    }

    function removeIdentical()
    {
      var divsLive = document.getElementsByClassName("imageDiv");
      var divs = [...divsLive];

      for (let div of divs)
      {
        var screenshot = div.getElementsByClassName("screenshotImg")[0];
        var reference = div.getElementsByClassName("refImg")[0];

        screenshot.style.width = 'auto';
        reference.style.width = 'auto';

        var identical = false;
        if (screenshot.width == reference.width)
        {
          identical = imagediff.equal(screenshot, reference , toleranceInput.value);
        }

        screenshot.style.width = imageWidth;
        reference.style.width = imageWidth;

        if (identical)
        {
          div.parentNode.removeChild(div);
        }
      }
    }

    function hideRefImages()
    {
      var liveElements = document.querySelectorAll('.refImg, .refTitle');
      var elements = [...liveElements];

      for (let element of elements)
      {
        element.style.display = element.style.display === 'none' ? '' : 'none';
      }
    }

    wrapImgTagInDiv();
    fillMasterUrl();

    window.onload = insertRefImages;
  </script>
</body>
</html>